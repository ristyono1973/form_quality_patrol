<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quality Patrol Form</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
 
</head>
<body class="bg-light">

<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Quality Patrol Form</h4>
    </div>
    <div class="card-body">
      <form id="patrolForm">
        <div class="mb-4">
          <label class="form-label">Tanggal & Jam</label>
          <input type="datetime-local" class="form-control" id="tanggal" required>
        </div>

        <div class="mb-4">
          <label for="lokasi" class="form-label">Lokasi</label>
          <select class="form-select" id="lokasi" required>
            <option value="" disabled selected>Pilih Lokasi</option>
            <option value="Mirror">Mirror</option>
            <option value="Ganesha">Ganesha</option>
            <option value="Cold C1">Cold C1</option>
            <option value="Cold C2">Cold C2</option>
            <option value="Log-Fab">Fab-Logistic</option>
             <option value="PMG-Fab">Fab-PMG</option>
            <option value="QC-Fab">Fab-QC</option>
            <option value="Log-Float-C">Float-Ckp-Logistic</option>           
            <option value="PMG-Float-C">Float-Ckp-PMG</option>
            <option value="RM-Float-C">Float-Ckp-RM</option>
            
            <option value="QC-Float-C">Float-Ckp-QC</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="jenis_patrol" class="form-label">Jenis Patrol</label>
          <select class="form-select" id="jenis_patrol" required>
            <option value="" disabled selected>Pilih Jenis Patrol</option>
            <option value="BOD Q-Patrol">BOD Q-Patrol</option>
            <option value="CM/FM Q-Patrol">CM/FM Q-Patrol</option>
            <option value="Dept. Q-Patrol">Dept. Q-Patrol</option>
            <option value="Staff Q-Patrol">Staff Q-Patrol</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="form-label">Item Temuan</label>
          <textarea class="form-control" id="item_temuan"></textarea>
        </div>

       <!--  <div class="mb-3">
          <label class="form-label">Foto Temuan</label>
          <input type="file" class="form-control" id="foto_temuan" accept="image/*" >
          <input type="file" class="form-control" id="foto_temuan" accept="image/*" capture="environment">
          <img id="preview" style="max-width:150px; margin-top:10px;" class="img-thumbnail d-none"/> 
        </div> -->

        <div class="mb-4">
          <label class="form-label">Foto Temuan</label>
          <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#fotoModal">
            Ambil/Pilih Foto
          </button>

          <!-- Input utama (dipakai untuk upload ke Supabase) -->
          <input type="file" id="foto_temuan" accept="image/*" style="display:none">

          <!-- Preview -->
          <div id="preview" class="mt-2"></div>
        </div>

        <button type="submit" class="btn btn-success w-100">Simpan</button>
      </form>
    </div>

    <!-- Modal Bootstrap -->
<div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fotoModalLabel">Pilih Sumber Foto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body text-center">
        <button type="button" class="btn btn-primary mb-2" onclick="openCamera()">üì∑ Kamera</button>
        <button type="button" class="btn btn-info" onclick="openGallery()">üñºÔ∏è Galeri</button>

        <!-- Input kamera & galeri hidden -->
        <input type="file" id="foto_kamera" accept="image/*" capture="environment" style="display:none">
        <input type="file" id="foto_galeri" accept="image/*" multiple style="display:none">
      </div>
    </div>
  </div>
</div>

  </div>
</div>


<script>
function openCamera() {
  document.getElementById("foto_kamera").click();
}
function openGallery() {
  document.getElementById("foto_galeri").click();
}

function previewFiles(input) {
  const preview = document.getElementById("preview");
  preview.innerHTML = "";
  Array.from(input.files).forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.style.maxWidth = "100px";
    img.style.margin = "5px";
    img.classList.add("img-thumbnail");
    preview.appendChild(img);
  });

  // Copy file ke input utama (foto_temuan)
  const dataTransfer = new DataTransfer();
  Array.from(input.files).forEach(file => dataTransfer.items.add(file));
  document.getElementById("foto_temuan").files = dataTransfer.files;

  // Tutup modal setelah pilih
  const modal = bootstrap.Modal.getInstance(document.getElementById("fotoModal"));
  modal.hide();
}

document.getElementById("foto_kamera").addEventListener("change", function() {
  previewFiles(this);
});
document.getElementById("foto_galeri").addEventListener("change", function() {
  previewFiles(this);
});
</script>


<script>
  const { createClient } = supabase;
  const supabaseUrl = "https://fjbllwtglssrcnzzdubp.supabase.co"; // ganti dengan URL project
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqYmxsd3RnbHNzcmNuenpkdWJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NTg4MDQsImV4cCI6MjA4NTAzNDgwNH0.Z611-KgsjRlsr9Y3S3COlfuAMLLUgh8_yzvHKDR_EU0"; // ganti dengan anon public key
  const client = createClient(supabaseUrl, supabaseKey);

  // Preview gambar
  document.getElementById("foto_temuan").addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (file) {
      const preview = document.getElementById("preview");
      preview.src = URL.createObjectURL(file);
      preview.classList.remove("d-none");
    }
  });

  // Fungsi compress gambar
  async function compressImage(file, maxWidth = 800, quality = 0.7) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob(
            (blob) => {
              resolve(new File([blob], file.name.replace(/\s+/g, "_"), { type: "image/jpeg" }));
            },
            "image/jpeg",
            quality // << Rasio kompres diatur di sini
          );
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // Submit form
  document.getElementById("patrolForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const tanggal = document.getElementById("tanggal").value;
    const lokasi = document.getElementById("lokasi").value;
    const jenis_patrol = document.getElementById("jenis_patrol").value;
    const item_temuan = document.getElementById("item_temuan").value;
    const fotoFile = document.getElementById("foto_temuan").files[0];

    let fotoUrl = null;

    if (fotoFile) {
      // hanya upload file hasil kompres
      const compressedFile = await compressImage(fotoFile, 800, 0.7); 
      const fileName = Date.now() + "_" + compressedFile.name;

      const { data, error } = await client.storage
        .from("patrol-images")
        .upload(fileName, compressedFile);

      if (error) {
        alert("Upload foto gagal: " + error.message);
        return;
      }

      const { data: publicUrlData } = client.storage
        .from("patrol-images")
        .getPublicUrl(fileName);

      fotoUrl = publicUrlData.publicUrl;
    }

    const { data: insertData, error: insertError } = await client
      .from("quality_patrol")
      .insert([{ tanggal, lokasi, jenis_patrol, item_temuan, foto_temuan: fotoUrl }]);

    if (insertError) {
      alert("Error: " + insertError.message);
    } else {
      alert("Data berhasil disimpan!");
      e.target.reset();
      document.getElementById("preview").classList.add("d-none");
    }
  });
</script>
</body>
</html>





